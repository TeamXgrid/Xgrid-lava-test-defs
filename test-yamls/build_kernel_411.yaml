metadata:
    name: build_kernel
    format: "Lava-Test-Shell Test Definition 2.0"
    description: "Compile Linux kernel"
    maintainer:
        - m.ali@xgrid.co
        - abdulq@xgrid.co
    os:
        - ubuntu
    scope:
        - functional
    devices:
        - panda
        - panda-es
        - arndale
        - vexpress-a9
        - vexpress-tc2
        - ifc6410
        - mustang-grub-efi

install:
    steps:
        - 'KERNEL_BRANCH="t99-4.11-stable/tip"'
        - 'CONFIG_BRANCH="master"'
        - 'KERNEL_REPO="git://12.108.191.254/thunder2/linux.git"'
        - 'TOOLS_REPO="git://12.108.191.254/thunder2/linux-tools.git"'
        - 'rm -rf /root/cavium'
        - 'mkdir -p /root/cavium; cd /root/cavium'
        - 'git clone $TOOLS_REPO'
        - 'cd /root/cavium/linux-tools/configs'
        - 'git checkout $CONFIG_BRANCH'
        - 'git pull --rebase'
        - 'echo "KERNEL CONFIGS UPDATED"'
        - 'cd /root/cavium/'
        - 'git clone $KERNEL_REPO'
        - 'cd /root/cavium/linux/'
        - 'git checkout $KERNEL_BRANCH'
        - 'git pull --rebase'
        - 'cp /root/cavium/linux-tools/configs/ubuntu-4.11-perf.config /root/cavium/linux/.config'
        - 'rm -rf /boot/vmlinuz-test'
        - 'rm -rf /boot/initrd.img-test'
        - 'make -j 72 -k'
        - 'make modules_install -j 72 -k'
        - 'make install -j 72 -k'
        - 'echo "Done with make"'
        - 'vmlinuz="/boot/vmlinuz-4.11*"; initrd="/boot/initrd.img-4.11*"'
        - 'md5sum $vmlinuz $initrd'
        - 'mv $vmlinuz /boot/vmlinuz-test'
        - 'mv $initrd /boot/initrd.img-test'
        - 'sync'
        - 'sleep 60'
        - 'md5sum /boot/vmlinuz-test /boot/initrd.img-test'
        - 'echo "LINUX KERNEL COMPILED WOOHHOOO"'

run:
    steps:
        - 'echo "PLEASE REBOOT"'
